fastlane_version '1.49.0'

default_platform :ios

platform :ios do
  before_all do
    # Version bump.
    increment_build_number

    # Prepare the codesigning.
    match(
      type:           'adhoc',
      app_identifier: 'com.soaringbook.runway'
    )

    # Build the application.
    gym(
      scheme:               'Runway',
      configuration:        'Production',
      clean:                true,
      use_legacy_build_api: true
    )
  end

  desc 'Upload this version to S3.'
  lane :s3 do
    # Upload to S3.
    s3(
      access_key:         ENV['S3_ACCESS_KEY'],
      secret_access_key:  ENV['S3_SECRET_ACCESS_KEY'],
      bucket:             ENV['S3_BUCKET'],
      region:             ENV['S3_REGION'],
      ipa:                'Runway.ipa',
      html_template_path: './fastlane/template/s3.erb'
    )
  end

  after_all do |lane|
    commit_version_bump
    add_git_tag prefix: 'v'
    push_to_git_remote
    
    clean_build_artifacts
  end
end
